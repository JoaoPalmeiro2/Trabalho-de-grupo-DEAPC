<?php

$db = new SQLite3('viaturas.db');


$db->exec("CREATE TABLE IF NOT EXISTS Viaturas(
    id INTEGER PRIMARY KEY,
    nome TEXT,
    preco REAL,
    descricao TEXT,
    imagem_path TEXT
)");


$db->exec("INSERT INTO Viaturas(nome, preco, descricao, imagem_path) 
          VALUES('SIT PIZZA', 19.496, 'Pequeno, rápido, e sempre a dar fome.', 'imagens/sit_pizza.jpg')");

$db->exec("INSERT INTO Viaturas(nome, preco, descricao, imagem_path) 
          VALUES('SIT LEÃO', 32.085, 'Parece feroz, mas mia ao subir uma ladeira.', 'iamgens/sit_leão.jpg')");

$db->exec("INSERT INTO Viaturas(nome, preco, descricao, imagem_path) 
          VALUES('SIT ARONHA', 22.024, 'Ideal para quem gosta subidas, mesmo que lentas.', 'imagens/sit_aronha.jpg')");

$db->exec("INSERT INTO Viaturas(nome, preco, descricao, imagem_path) 
          VALUES('SIT ASECA', 34.175, 'SUV com zero emoção, seco como o nome.', 'imagens/sit_aseca.jpg')");


// Processar formulário de adição de nova viatura
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_FILES['imagem'])) {
    $nome = $_POST['nome'];
    $preco = (float)$_POST['preco'];
    $descricao = $_POST['descricao'];
    
    // Processar upload da imagem
    $nome_arquivo = uniqid() . '_' . basename($_FILES['imagem']['name']);
    $caminho_imagem = 'imagens/' . $nome_arquivo;
    
    if (move_uploaded_file($_FILES['imagem']['tmp_name'], $caminho_imagem)) {
        $stmt = $db->prepare("INSERT INTO Viaturas(nome, preco, descricao, imagem_path) VALUES(?, ?, ?, ?)");
        $stmt->bindValue(1, $nome, SQLITE3_TEXT);
        $stmt->bindValue(2, $preco, SQLITE3_FLOAT);
        $stmt->bindValue(3, $descricao, SQLITE3_TEXT);
        $stmt->bindValue(4, $caminho_imagem, SQLITE3_TEXT);
        $stmt->execute();
    }
}

// Função para exibir viaturas
function exibirViaturas($db) {
    $resultado = $db->query("SELECT * FROM Viaturas ORDER BY nome, preco");
    
    echo '<div class="viaturas-container">';
    while ($row = $resultado->fetchArray(SQLITE3_ASSOC)) {
        echo '<div class="viatura-card">';
        echo '<div class="viatura-info">';
        echo '<h3>' . htmlspecialchars($row['nome']) . '</h3>';
        echo '<p class="preco">€' . number_format($row['preco'], 3) . '</p>';
        echo '<p class="descricao">' . htmlspecialchars($row['descricao']) . '</p>';
        echo '</div>';
        
        if (!empty($row['imagem_path']) && file_exists($row['imagem_path'])) {
            echo '<img src="' . htmlspecialchars($row['imagem_path']) . '" alt="' . htmlspecialchars($row['nome']) . '">';
        } else {
            echo '<div class="sem-imagem">Sem imagem</div>';
        }
        
        echo '</div>';
    }
    echo '</div>';
}
?>